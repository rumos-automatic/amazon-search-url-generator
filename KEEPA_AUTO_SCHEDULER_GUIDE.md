# Keepa API 自動処理スケジューラー ガイド

## 🚀 概要

10分おきに自動実行されるトリガーで、Keepa APIを使ってAmazon商品データを取得します。
トークン制限に柔軟に対応し、トークンが尽きたら次回トリガーで自動的に再開します。

---

## ✨ 主な機能

### 1. 自動処理（10分おきのトリガー）
- A列にASINがあり、B列が空欄の行を自動処理
- トークンが尽きたら処理を中断し、次回トリガーで再開
- バックグラウンドで自動的に処理が進む

### 2. トークン残数の可視化
- ヘッダー行（F列）にトークン情報を表示
- 表示内容: `Keepa残トークン: 15 | 処理完了 | 更新: 11/07 12:34`
- 毎回のトリガー実行で自動更新

### 3. インテリジェントなエラーハンドリング
- **トークン不足**: B列を空欄のまま残し、次回トリガーで再試行
- **それ以外のエラー**: B列に「エラー: HTTP 403」などを記録し、処理完了扱い

---

## 📋 使い方

### 初期設定

#### 1. Keepa API Keyを設定

```
「設定」シートを開く
  ↓
KEEPA_API_KEY 行にAPIキーを入力
```

#### 2. トリガーを開始

```
メニュー「Amazon URL生成」
  ↓
「トリガー設定（自動処理）」
  ↓
「10分おきの自動処理を開始」をクリック
```

→ これで完了！10分おきに自動処理が開始されます。

---

## 🎯 処理フロー

```
10分おきにトリガー起動
  ↓
1. Keepa APIでトークン残数を確認
  ↓
2. トークンがあれば処理開始、なければ終了
  ↓
3. A列にASIN、B列が空欄の行を上から順に取得
  ↓
4. 1行ずつ処理:
   ├─ 成功 → B列にブランド名、C-E列にカテゴリ/URL
   ├─ トークンエラー → B列空欄のまま、処理中断
   └─ それ以外のエラー → B列にエラーメッセージ
  ↓
5. ヘッダー行のトークン情報を更新
  ↓
6. 次回トリガーまで待機...
```

---

## 📊 トークン情報の見方

### ヘッダー行（F列）の表示例

```
Keepa残トークン: 15 | 処理完了 | 更新: 11/07 12:34
```

| 項目 | 説明 |
|------|------|
| **残トークン数** | 現在利用可能なKeepa APIトークン数 |
| **処理状況** | 「処理完了」「トークン不足」「処理対象なし」など |
| **更新日時** | 最後にトリガーが実行された日時 |

### 処理状況の種類

| 状況 | 意味 |
|------|------|
| **処理完了** | 正常に処理が完了した |
| **トークン不足で中断** | トークンが尽きて処理を中断した |
| **トークン不足** | 最初からトークンがなかった |
| **処理対象なし** | 未処理の行が見つからなかった |
| **API Key未設定** | KEEPA_API_KEYが設定されていない |
| **トークン取得失敗** | トークン残数の取得に失敗した |

---

## ⚙️ メニュー詳細

### 「トリガー設定（自動処理）」サブメニュー

#### 1. 10分おきの自動処理を開始
- 10分おきのトリガーを作成
- 自動処理を開始します

#### 2. 自動処理を停止
- アクティブなトリガーを削除
- 自動処理を停止します

#### 3. 今すぐ手動実行
- トリガーを待たずに即座に処理を実行
- デバッグやテストに便利

---

## 🔧 トリガーの仕組み

### トリガー設定

- **実行間隔**: 10分おき
- **実行関数**: `processKeepaScheduled()`
- **トリガー種類**: 時間ベースのトリガー

### トリガー管理

Google Apps Scriptのトリガー管理画面で確認できます：

```
Apps Script エディタを開く
  ↓
左メニュー「トリガー」⏰ をクリック
  ↓
processKeepaScheduled のトリガーが表示される
```

---

## 💡 推奨ワークフロー

### 通常運用

```
1. A列にASINを追加（B列は空欄のまま）
2. トリガーが自動的に処理
3. ヘッダー行でトークン残数と処理状況を確認
4. 完了するまで放置
```

### 大量データの処理

```
1. 100件のASINをA列に貼り付け
2. トリガー開始
3. 基本プラン（1トークン/分）の場合:
   - 10分 = 最大10件処理
   - 100件 = 約100分（1.7時間）で完了
4. ヘッダー行で進捗を確認
```

---

## 🚨 トラブルシューティング

### Q1: トリガーが動いていない

**確認事項**:
- Apps Scriptのトリガー管理画面でトリガーが存在するか確認
- メニュー「トリガー設定」→「10分おきの自動処理を開始」を再実行

### Q2: ずっと「トークン不足」のまま

**原因**:
- Keepa APIの基本プランは1トークン/分で回復
- 10分 = 最大10トークン回復

**対策**:
- より高速なKeepa APIプランにアップグレード
- または、トリガー間隔を15分や20分に延長（手動で設定）

### Q3: エラーが頻発する

**確認事項**:
- 「設定」シートのKEEPA_API_KEYが正しいか確認
- Logger.log()で詳細なエラーメッセージを確認

```
Apps Script エディタ
  ↓
左メニュー「実行数」📊 をクリック
  ↓
最新の実行ログを確認
```

### Q4: トークン残数が表示されない

**原因**:
- F列にヘッダーが手動で入力されている
- または、ヘッダー行が削除されている

**対策**:
- F1セルを空にして、トリガーを再実行
- または、手動で「今すぐ手動実行」を実行

---

## 📈 処理速度の目安

### Keepa API 基本プラン（1トークン/分）

| 未処理件数 | 処理時間（概算） |
|-----------|---------------|
| 10件 | 10分（1回のトリガー） |
| 50件 | 50分（5回のトリガー） |
| 100件 | 100分（10回のトリガー） |
| 500件 | 500分 ≈ 8時間 |

**注**: トークンは1分ごとに1つ回復するため、10分おきのトリガーでは最大10件/回処理できます。

### より高速なプラン

Keepaの上位プランでは、より高速なトークン回復が可能です。
詳細は [Keepa.com](https://keepa.com/) で確認してください。

---

## 🔐 セキュリティとプライバシー

### API Keyの管理

- API Keyは「設定」シートに保存されます
- スプレッドシートの共有設定に注意してください
- API Keyは決して公開しないでください

### トリガーの権限

- トリガーは、スプレッドシートのオーナーのGoogleアカウントで実行されます
- 他のユーザーにスプレッドシートを共有しても、トリガーはオーナーのアカウントで実行されます

---

## 🎛️ 高度な設定

### トリガー間隔のカスタマイズ

10分以外の間隔で実行したい場合は、手動で設定できます：

```javascript
// src/KeepaScheduler.gs の setupKeepaScheduler() を編集

ScriptApp.newTrigger('processKeepaScheduled')
  .timeBased()
  .everyMinutes(15)  // 10 → 15に変更
  .create();
```

### 処理件数の制限

1回のトリガーで処理する最大件数を制限したい場合：

```javascript
// src/KeepaScheduler.gs の processKeepaScheduled() に追加

let processedCount = 0;
const MAX_PROCESS_COUNT = 5;  // 最大5件まで

for (let rowNum = 2; rowNum <= lastRow; rowNum++) {
  // ...
  if (processedCount >= MAX_PROCESS_COUNT) {
    Logger.log(`最大処理件数 ${MAX_PROCESS_COUNT} に達しました`);
    break;
  }
  // ...
}
```

---

## 📚 関連ドキュメント

- [KEEPA_SETUP_GUIDE.md](./KEEPA_SETUP_GUIDE.md) - Keepa API セットアップガイド
- [KEEPA_API_MIGRATION_GUIDE.md](./KEEPA_API_MIGRATION_GUIDE.md) - スクレイピングからの移行ガイド
- [CATEGORY_CODE_SOLUTION.md](./CATEGORY_CODE_SOLUTION.md) - カテゴリコード変換の解説
- [AMAZON_CATEGORY_CODES_REFERENCE.md](./AMAZON_CATEGORY_CODES_REFERENCE.md) - 89カテゴリ完全リファレンス

---

## 🎉 まとめ

- ✅ **完全自動**: 10分おきに自動処理、放置でOK
- ✅ **トークン管理**: 残数を可視化、不足時は自動再試行
- ✅ **柔軟なエラー処理**: トークンエラーとその他を区別
- ✅ **進捗確認**: ヘッダー行で常に最新状況を表示

**これで、バックグラウンドで自動的にデータ取得が完了します！** 🚀

---

**更新日**: 2025-11-07
**バージョン**: v2.2.0
**作成者**: Created with Claude Code
